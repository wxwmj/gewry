name: Auto Update Sub

on:
  schedule:
    - cron: '0 4,11,14,21 * * *'   # æ¯å¤©åŒ—äº¬æ—¶é—´ 05:00ã€12:00ã€19:00ã€22:00 æ‰§è¡Œ
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

jobs:
  update-sub:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false  # é˜²æ­¢ä½¿ç”¨é»˜è®¤çš„ GitHub tokenï¼Œé¿å…æƒé™é—®é¢˜

      - name: ğŸ”§ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'  # ä½¿ç”¨ Python 3.xï¼Œç¡®ä¿å®‰è£…æœ€æ–°ç‰ˆæœ¬

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install -r requirements.txt  # å®‰è£…æ‰€éœ€çš„ä¾èµ–

      - name: ğŸš€ Run Node Checker
        run: python node_checker.py  # æ‰§è¡Œæ›´æ–°è®¢é˜…çš„ Python è„šæœ¬ï¼Œå‡è®¾è¯¥è„šæœ¬ä¼šæ›´æ–°è®¢é˜…

      - name: ğŸ“¤ Commit and push updated sub
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}  # ä½¿ç”¨ GitHub secret ä¸­å­˜å‚¨çš„ token æ¥è¿›è¡Œèº«ä»½éªŒè¯
        run: |
          # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # è®¾ç½®è¿œç¨‹ä»“åº“ URL ä½¿ç”¨ token è®¤è¯ï¼Œç¡®ä¿æäº¤æ—¶ä¸ä¼šæš´éœ²å¯†ç 
          git remote set-url origin https://x-access-token:${PAT_TOKEN}@github.com/${{ github.repository }}.git
          
          # å°†æ›´æ–°çš„ sub æ–‡ä»¶æ·»åŠ åˆ° git å¹¶æäº¤
          git add sub  # å‡è®¾æ›´æ–°çš„è®¢é˜…æ–‡ä»¶åœ¨ 'sub' ç›®å½•ä¸‹ï¼Œä¿®æ”¹ä¸ºä½ å®é™…è·¯å¾„
          
          # å¦‚æœæ²¡æœ‰æ›´æ–°ï¼Œè·³è¿‡æäº¤
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–° sub æ–‡ä»¶ $(date '+%Y-%m-%d %H:%M:%S')" || echo "æ— å˜åŒ–æ— éœ€æäº¤"
          
          # æäº¤å¹¶æ¨é€åˆ°ä»“åº“
          git push origin HEAD:${{ github.ref_name }}
